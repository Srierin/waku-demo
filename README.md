# Mini Encrypted Chat

基于Waku协议的迷你加密聊天应用，支持点对点和群组聊天，提供消息加密、撤回、历史消息等功能。

## 核心功能

- ✅ **直接聊天**：两个用户之间的点对点通信
- ✅ **群组聊天**：支持多个用户的群组通信
- ✅ **消息加密**：确保消息的机密性和完整性
- ✅ **消息撤回**：支持发送者撤回消息
- ✅ **本地删除**：支持用户本地删除消息
- ✅ **历史消息**：支持从Store节点拉取历史消息
- ✅ **身份持久化**：用户身份可跨会话复用
- ✅ **P2P通信**：基于Waku协议的去中心化通信

## 技术实现

### 身份管理

- **身份生成**：使用以太坊钱包生成用户身份
- **身份持久化**：将身份存储在本地存储中，确保跨会话复用
- **身份结构**：包含peerId（钱包地址）、privateKey、publicKey

### 消息加密

- **密钥生成**：使用会话ID和用户公钥生成会话加密密钥
- **加密方式**：使用改进的XOR加密方案，结合哈希函数增强安全性
- **消息认证**：使用消息签名和消息认证码（MAC）确保消息完整性
- **安全级别**：提供基本的机密性和完整性保护

### 历史消息

- **存储方式**：使用Waku Store节点拉取历史消息
- **拉取范围**：默认拉取最近7天的消息
- **分页机制**：每页拉取50条消息，支持批量拉取
- **错误处理**：拉取失败时返回本地存储的消息

### 删除与撤回

- **本地删除**：用户可在本地删除消息，不再显示
- **消息撤回**：发送者可撤回消息，其他用户收到后标记为"已撤回"
- **撤回验证**：只有原发送者可撤回消息，通过消息签名验证
- **边界说明**：无法保证所有节点都真正删除消息，因为Waku是去中心化网络

### P2P通信

- **协议**：使用Waku v2协议
- **节点类型**：使用LightNode（轻节点）
- **传输**：使用LightPush和Filter协议
- **本地网络**：支持本地Waku节点部署

## 本地网络环境

### 启动本地Waku节点

```bash
# 使用提供的脚本启动本地Waku节点
npm run start-waku
```

脚本会：
1. 检查Docker是否安装并运行
2. 拉取Waku镜像
3. 启动本地Waku节点，暴露端口60000（P2P）、9000（HTTP）、8545（RPC）
4. 启用Relay、Filter、LightPush、Store协议

### 节点信息

- **节点地址**：`/ip4/127.0.0.1/tcp/60000/p2p/16Uiu2HAmPLe7Mzm8TsYUubgCAW1aJoeFScxrLj8ppHFivPo97bUZ`
- **RPC端点**：`http://localhost:8545`

## 演示脚本

### 运行演示

```bash
# 运行2用户+1群组的演示脚本
npm run demo
```

### 演示内容

1. 创建两个用户身份
2. 建立直接聊天会话
3. 发送和接收消息
4. 建立群组聊天会话
5. 在群组中发送消息
6. 测试消息撤回功能
7. 测试历史消息拉取

## 如何运行

### 1. 安装依赖

```bash
npm install
```

### 2. 启动本地Waku节点（可选）

```bash
npm run start-waku
```

### 3. 启动开发服务器

```bash
npm run dev
```

### 4. 访问应用

打开浏览器访问：`http://localhost:5173`

### 5. 测试模式

应用会自动启用测试模式，创建两个用户身份，方便测试所有功能。

## 限制与边界

### 安全限制

- **加密方案**：当前使用改进的XOR加密，实际生产环境应使用AES-256-GCM等更安全的加密方案
- **密钥交换**：当前使用简化的密钥生成方案，实际生产环境应使用Diffie-Hellman密钥交换
- **签名验证**：当前使用简化的签名验证，实际生产环境应使用标准的以太坊签名验证

### 网络限制

- **消息传递**：Waku是概率性路由，无法保证消息100%传递
- **消息顺序**：无法保证消息的严格顺序
- **消息删除**：无法保证所有节点都真正删除消息
- **节点发现**：在某些网络环境下，节点发现可能较慢

### 功能限制

- **群组管理**：当前不支持群组管理功能（如添加/移除成员）
- **消息状态**：不支持已读/未读状态
- **消息类型**：只支持文本消息，不支持图片、文件等
- **用户界面**：界面较为简单，仅用于演示

## 技术栈

- **前端**：React + TypeScript + Vite
- **后端**：Waku SDK + ethers.js
- **网络**：Waku v2协议
- **容器**：Docker

## 核心文件

- **`src/sdk/chat-sdk.ts`**：核心SDK实现
- **`src/sdk/types.ts`**：类型定义
- **`src/App.tsx`**：React应用界面
- **`start-waku-node.bat`**：本地Waku节点启动脚本
- **`demo-script.js`**：演示脚本

## 总结

本项目实现了一个基于Waku协议的迷你加密聊天应用，展示了去中心化通信的核心概念和技术实现。虽然功能和安全性还有提升空间，但已经覆盖了基本的聊天功能和安全需求，可作为学习Waku协议和去中心化通信的参考。

### 未来改进方向

1. 使用AES-256-GCM等更安全的加密方案
2. 实现完整的Diffie-Hellman密钥交换
3. 支持更多消息类型（图片、文件等）
4. 增强群组管理功能
5. 优化用户界面和用户体验
6. 增加消息状态管理（已读/未读）
7. 实现消息同步机制，确保多设备一致性
